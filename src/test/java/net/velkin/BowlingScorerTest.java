package net.velkin;

import org.junit.jupiter.api.Test;

import java.io.ByteArrayOutputStream;
import java.io.PrintStream;
import java.nio.charset.StandardCharsets;
import java.util.Scanner;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

class BowlingScorerTest {
    private static final String RANDOM_RUN_OUTPUT = """
                Let's bowl! Type number of knocked pins for each roll.
                Frame #1, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │       │       │       │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #1, Roll #2:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │       │       │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #2, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │       │       │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #2, Roll #2:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │       │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #3, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │       │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #3, Roll #2:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #4, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #4, Roll #2:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │   │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │       │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #5, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │   │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │       │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #5, Roll #2:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │   │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #6, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │   │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #7, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │ ╳ │   │   │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │       │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #8, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │ ╳ │   │ ╳ │   │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │   82  │       │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #9, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │ ╳ │   │ ╳ │ 6 │   │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │   82  │  108  │       │       │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #9, Roll #2:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │ ╳ │   │ ╳ │ 6 │ 3 │   │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │   82  │  108  │  127  │  136  │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #10, Roll #1:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │ ╳ │   │ ╳ │ 6 │ 3 │ 8 │   │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │   82  │  108  │  127  │  136  │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #10, Roll #2:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │ ╳ │   │ ╳ │ 6 │ 3 │ 8 │ ╱ │   │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │   82  │  108  │  127  │  136  │           │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Frame #10, Roll #3:\s
                ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
                │ 6 │ 2 │ 7 │ 2 │ 3 │ 4 │ 8 │ ╱ │ 9 │ ─ │   │ ╳ │   │ ╳ │   │ ╳ │ 6 │ 3 │ 8 │ ╱ │ 7 │
                │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
                │    8  │   17  │   24  │   43  │   52  │   82  │  108  │  127  │  136  │    153    │
                └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                                
                Game over!
                """;
    private static final String ERROR_RUN_INPUT = """
                 11
                 6
                 6
                 zdfg
                 quit
                """;
    private static final String ERROR_RUN_OUTPUT = """
            Let's bowl! Type number of knocked pins for each roll.
            Frame #1, Roll #1: Invalid knocked pins count
            Frame #1, Roll #1:\s
            ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
            │ 6 │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
            │   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┤   └───┼───┴───┴───┤
            │       │       │       │       │       │       │       │       │       │           │
            └───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────┘
                            
            Frame #1, Roll #2: Too many knocked pins for one frame
            Frame #1, Roll #2: I did not get it! Try a number of knocked pins, or "exit" or "quit".
            Frame #1, Roll #2: Bye!
            """;
    private static final String BUG_RUN_OUTPUT = """
            Let's bowl! Type number of knocked pins for each roll.
            Frame #1, Roll #1:\s
            Looks like we messed up. Please report this error:
            net.velkin.Bug: Bug!!!
            """;

    private final BowlingScorer runner = new BowlingScorer();

    private void testRun(String input, String expectedOutput) {
        ByteArrayOutputStream output = new ByteArrayOutputStream();
        PrintStream printStream = new PrintStream(output, true, StandardCharsets.UTF_8);
        Scanner scanner = new Scanner(input);
        try (printStream; scanner) {
            runner.run(printStream, scanner);
            assertEquals(expectedOutput, output.toString().replace("\r\n", "\n"));
        }
    }

    @Test
    public void testRandomRun() {
        StringBuilder sb = new StringBuilder();
        for (int[] datum : TestGames.RANDOM.rolls) {
            for (int i = 0; i < 2; i++) {
                if (datum[i] >= 0)
                    sb.append(datum[i]).append('\n');
            }
        }
        testRun(sb.toString(), RANDOM_RUN_OUTPUT);
    }

    @Test
    public void testErrorRun() {
        testRun(ERROR_RUN_INPUT, ERROR_RUN_OUTPUT);
    }

    @Test
    public void testBugRun() {
        ByteArrayOutputStream output = new ByteArrayOutputStream();
        PrintStream printStream = new PrintStream(output, true, StandardCharsets.UTF_8);
        Scanner scanner = mock(Scanner.class);
        when(scanner.hasNextInt()).thenThrow(new Bug("Bug!!!"));
        try (printStream; scanner) {
            runner.run(printStream, scanner);
            assertTrue(output.toString().replace("\r\n", "\n").startsWith(BUG_RUN_OUTPUT));
        }
    }
}
